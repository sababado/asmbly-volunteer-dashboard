name: Frontend CI/CD

on:
  push:
    branches:
      - main
      - dev
      - staging
    paths:
      - 'apps/frontend/**'
      - 'packages/ui-kit/**'
      - '.github/workflows/frontend.yml'

jobs:
  test:
    name: Test Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint Frontend
        run: npm run lint -w apps/frontend



      - name: Build Frontend (Test)
        run: npm run build -w apps/frontend

  deploy:
    name: Deploy Frontend
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Frontend
        run: npm run build -w apps/frontend

      - name: Determine Environment
        id: env-state
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV_NAME=prod" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "ENV_NAME=staging" >> $GITHUB_ENV
          else
            echo "ENV_NAME=dev" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::110104886034:role/GitHub-OIDC-asmbly-volunteer-dashboard-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Infrastructure Details
        id: infra
        run: |
          STACK_NAME="asmbly-volunteer-dashboard-backend-${{ env.ENV_NAME }}"
          echo "Fetching outputs from stack: $STACK_NAME"
          
          OUTPUTS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs" --output json)
          
          BUCKET_NAME=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="FrontendBucketName") | .OutputValue')
          CLOUDFRONT_DOMAIN=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="CloudFrontDomain") | .OutputValue')
          
          if [ -z "$BUCKET_NAME" ] || [ "$BUCKET_NAME" == "null" ]; then
            echo "::error::FrontendBucketName not found in stack outputs"
            exit 1
          fi
          
          echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV
          echo "CLOUDFRONT_DOMAIN=$CLOUDFRONT_DOMAIN" >> $GITHUB_ENV

      - name: Sync to S3
        run: |
          echo "Syncing to s3://$BUCKET_NAME"
          aws s3 sync apps/frontend/dist s3://$BUCKET_NAME --delete

      - name: Invalidate CloudFront
        run: |
          if [ -n "$CLOUDFRONT_DOMAIN" ] && [ "$CLOUDFRONT_DOMAIN" != "null" ]; then
            DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?DomainName=='$CLOUDFRONT_DOMAIN'].Id" --output text)
            
            if [ -n "$DIST_ID" ]; then
              echo "Invalidating CloudFront Distribution: $DIST_ID"
              aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
            else
              echo "::warning::Could not find CloudFront Distribution ID for domain: $CLOUDFRONT_DOMAIN"
            fi
          else
            echo "::warning::CloudFront Domain not found in stack outputs. Skipping invalidation."
          fi
